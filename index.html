<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kamhanga advanced Group 2024/2025</title>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --accent: #f39c12;
            --danger: #e74c3c;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark);
            font-size: 16px;
            line-height: 1.6;
            overflow-x: hidden;
        }

        #loadingScreen {
            position: fixed;
            top: 0;
            left:0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e90ff, #ff00cc);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 8px solid rgba(255, 255, 255, 0.2);
            border-top: 8px solid #fff;
            border-radius: 50%;
            animation: spin 1.5s infinite ease-in-out, colorChange 3s infinite;
            position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50% ) ;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes colorChange {
            0% { border-top-color: #fff; }
            33% { border-top-color: #ff00cc; }
            66% { border-top-color: #1e90ff; }
            100% { border-top-color: #fff; }
        }

        .loading-text {
            color: white;
            font-size: 24px;
            margin-top: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .container {
            max-width: 100%;
            padding: 15px;
            display: none;
        }

        .header {
            position: relative;
            background: linear-gradient(45deg, #1e90ff, #ff00cc);
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="rgba(255,255,255,0.2)" d="M0,160L48,176C96,192,192,224,288,213.3C384,203,480,149,576,133.3C672,117,768,139,864,149.3C960,160,1056,160,1152,149.3C1248,139,1344,117,1392,106.7L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
            animation: moveClouds 20s infinite linear;
        }

        @keyframes moveClouds {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .welcome {
            font-size: 18px;
            position: relative;
            z-index: 1;
        }

        .status-btn, .month-btn {
            display: inline-block;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 14px;
            position: relative;
            z-index: 1;
        }

        .nav-menu {
            margin-bottom: 20px;
        }

        .nav-menu ul {
            list-style: none;
            background: var(--dark);
            border-radius: 10px;
            display: flex;
            flex-wrap: wrap;
            padding: 10px;
        }

        .nav-menu li {
            padding: 15px 20px;
            color: var(--light);
            cursor: pointer;
            transition: background 0.3s;
            flex: 1 1 100%;
        }

        .nav-menu li:hover {
            background: var(--primary);
        }

        .nav-menu li.active {
            background: var(--primary);
        }

        .nav-menu .icon {
            margin-right: 10px;
        }

        .tab-content {
            display: none;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .card h2 {
            margin-bottom: 15px;
            color: var(--dark);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            background: #7100eb;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            background: #ebc4b0;
            box-shadow: 0 0 5px var(--primary);
        }

        .modern-select {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            box-shadow: var(--shadow);
            appearance: none;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTIgNEw4IDhMNCwxMiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=');
            background-repeat: no-repeat;
            background-position: right 15px center;
            cursor: pointer;
        }

        .modern-select option {
            background: #fff;
            color: #333;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--secondary);
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }

        .modal-content.success {
            border-top: 5px solid var(--secondary);
        }

        .modal-content.error {
            border-top: 5px solid var(--danger);
        }

        .modal-content.info {
            border-top: 5px solid var(--primary);
        }

        .close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .announcement {
            background: linear-gradient(135deg, #ff00cc, #1e90ff);
            padding: 15px;
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            animation: pulse 2s infinite;
        }

        .announcement::before {
            content: '📢';
            position: absolute;
            font-size: 50px;
            top: 10px;
            left: 10px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .announcement-text {
            margin-left: 60px;
        }

        .footer {
            text-align: center;
            padding: 20px;
            background: var(--dark);
            color: var(--light);
            border-radius: 10px;
            margin-top: 20px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .table th {
            background: var(--primary);
            color: white;
        }

        @media (min-width: 768px) {
            .container { max-width: 1200px; margin: 0 auto; }
            .nav-menu li { flex: 1 1 auto; }
            .form-group input, .form-group select, .modern-select { max-width: 500px; }
        }

        @media (max-width: 767px) {
            .nav-menu ul { flex-direction: column; }
            .header h1 { font-size: 22px; }
            .loading-text { font-size: 18px; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="loadingScreen">
        <div>
            <div class="spinner"></div>
            <div class="loading-text">Please wait.....<br></div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>KAMHANGA ADVANCED GROUP 2014-2018</h1>
            <div class="welcome">Karibu Sana! Pamoja Tunaweza Zaidi.</div>
            <div><span class="status-btn">Online</span> <span class="month-btn">Sasa tupo April</span></div>
        </div>

        <div id="announcementDisplay" class="announcement">
            <div class="announcement-text" id="announcementText"></div>
        </div>

        <div class="nav-menu">
            <ul>
                <li class="active" onclick="openTab('home')"><span class="icon">🏠</span>Nyumbani</li>
                <li onclick="openTab('register')"><span class="icon">👤</span>Usajiri wa wanachama wapya</li>
                <li onclick="openTab('payment')"><span class="icon">💰</span>Fanya Malipo yote hapa</li>
                <li onclick="openTab('debtors')"><span class="icon">📉</span>Hali ya Malipo ya ada</li>
                <li onclick="openTab('contributions')"><span class="icon">🤝</span> hali ya kila michango  Michango yote</li>
                <li onclick="openTab('finance')"><span class="icon">📊</span>Mapato na Matumizi</li>
                <li onclick="openTab('personal')"><span class="icon">🧑</span>Taarifa Binafsi za kila mwanachama</li>
                <li onclick="openTab('constitution')"><span class="icon">📜</span>Katiba na sheria za kundi</li>
                <li onclick="openTab('membersListAlpha')"><span class="icon">📋</span>Majina ya wanachama wote</li>
                <li onclick="openTab('print')"><span class="icon">🖨️</span>Chapisha</li>
                <li onclick="openTab('comments')"><span class="icon">💬</span>Maoni</li>
                <li onclick="openTab('admin')"><span class="icon">🔒</span>matumizi ya viongozi tu </li>
            </ul>
        </div>

        <div id="home" class="tab-content" style="display: block;">
            <div class="card">
                <h2>Karibu!</h2>
                <p>Karibu kwenye Mfumo Imara wa Usajili na Ufuatiliaji wa Malipo wa Kamhanga Advanced Group suluhisho mahususi kwa kikundi chetu, kikiwa na uwazi, ufanisi, na usalama wa hali ya juu katika usimamizi wa michango na ada!</p>
            </div>
        </div>

        <div id="register" class="tab-content">
            <div class="card">
                <h2>Usajili</h2>
                <form id="registrationForm">
                    <div class="form-group">
                        <label>Jina Kamili</label>
                        <input type="text" id="fullName" required>
                    </div>
                    <div class="form-group">
                        <label>Namba ya Simu</label>
                        <input type="tel" id="phone" required>
                    </div>
                    <div class="form-group">
                        <label>Mtaa</label>
                        <input type="text" id="address" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Jisajili</button>
                </form>
            </div>
        </div>

        <div id="payment" class="tab-content">
            <div class="card">
                <h2>Fanya Malipo</h2>
                <form id="paymentForm">
                    <div class="form-group">
                        <label>Chagua Jina</label>
                        <select id="paymentMember" required>
                            <option value="">Chagua Mwanachama</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Aina ya Malipo</label>
                        <select id="paymentType" onchange="togglePaymentFields()" required>
                            <option value="">Chagua</option>
                            <option value="Ada">Ada</option>
                            <option value="Hela ya Kiingilio">Hela ya Kiingilio</option>
                            <option value="Maafa na Starehe">Maafa na Starehe</option>
                            <option value="Tuinuane">Tuinuane</option>
                            <option value="Kurudisha Mkopo">Kurudisha Mkopo</option>
                            <option value="Michango Mingine">Michango Mingine</option>
                        </select>
                    </div>
                    <div class="form-group" id="feeMonthField" style="display: none;">
                        <label>Ada ya Mwezi</label>
                        <select id="feeMonth">
                            <option value="January">Januari</option>
                            <option value="February">Februari</option>
                            <option value="March">Machi</option>
                            <option value="April">Aprili</option>
                            <option value="May">Mei</option>
                            <option value="June">Juni</option>
                            <option value="July">Julai</option>
                            <option value="August">Agosti</option>
                            <option value="September">Septemba</option>
                            <option value="October">Oktoba</option>
                            <option value="November">Novemba</option>
                            <option value="December">Disemba</option>
                        </select>
                    </div>
                    <div class="form-group" id="dateField" style="display: none;">
                        <label>Tarehe</label>
                        <input type="date" id="paymentDate">
                    </div>
                    <div class="form-group">
                        <label>Kiasi (TSh)</label>
                        <input type="number" id="paymentAmount" min="1" required>
                    </div>
                    <button type="submit" class="btn btn-success">Tuma</button>
                </form>
            </div>
        </div>

        <div id="debtors" class="tab-content">
            <div class="card">
                <h2>Hali ya Malipo</h2>
                <div class="form-group">
                    <select id="debtMonth" class="modern-select" onchange="loadDebtors()">
                        <option value="">Chagua Mwezi</option>
                        <option value="January">Januari</option>
                        <option value="February">Februari</option>
                        <option value="March">Machi</option>
                        <option value="April">Aprili</option>
                    </select>
                </div>
                <div id="debtorsList"></div>
            </div>
        </div>

        <div id="contributions" class="tab-content">
            <div class="card">
                <h2>Michango</h2>
                <div class="form-group">
                    <select id="contributionType" class="modern-select" onchange="loadContributions()">
                        <option value="">Chagua Aina</option>
                        <option value="Ada">Ada</option>
                        <option value="Hela ya Kiingilio">Hela ya Kiingilio</option>
                        <option value="Maafa na Starehe">Maafa na Starehe</option>
                        <option value="Tuinuane">Tuinuane</option>
                        <option value="Kurudisha Mkopo">Kurudisha Mkopo</option>
                        <option value="Michango Mingine">Michango Mingine</option>
                    </select>
                </div>
                <div id="contributionsList"></div>
            </div>
        </div>

        <div id="finance" class="tab-content">
            <div class="card">
                <h2>Mapato/Matumizi</h2>
                <div class="form-group">
                    <label>Andika Mapato</label>
                    <input type="number" id="incomeAmount" placeholder="Kiasi (TSh)">
                    <button class="btn btn-primary" onclick="addIncome()">Ongeza</button>
                </div>
                <div class="form-group">
                    <label>Andika Matumizi</label>
                    <input type="number" id="expenseAmount" placeholder="Kiasi (TSh)">
                    <input type="text" id="expenseDesc" placeholder="Maelezo">
                    <button class="btn btn-danger" onclick="addExpense()">Ongeza</button>
                </div>
                <div id="financeSummary"></div>
                <button class="btn btn-primary" onclick="generateFinanceReport('week')">Ripoti ya Wiki (PDF)</button>
                <button class="btn btn-primary" onclick="generateFinanceReport('month')">Ripoti ya Mwezi (PDF)</button>
                <button class="btn btn-primary" onclick="generateFinanceReport('year')">Ripoti ya Mwaka (PDF)</button>
            </div>
        </div>

        <div id="personal" class="tab-content">
            <div class="card">
                <h2>Taarifa Binafsi</h2>
                <div class="form-group">
                    <select id="personalMember" class="modern-select" onchange="loadPersonalReport()">
                        <option value="">Chagua Mwanachama</option>
                    </select>
                </div>
                <div id="personalReport"></div>
            </div>
        </div>

        <div id="constitution" class="tab-content">
            <div class="card">
                <h2>Katiba Yetu</h2>
                <div id="constitutionContent"></div>
            </div>
        </div>

        <div id="membersListAlpha" class="tab-content">
            <div class="card">
                <h2>Wanachama</h2>
                <div id="membersListAlphabet"></div>
            </div>
        </div>

        <div id="print" class="tab-content">
            <div class="card">
                <h2>Chapisha Taarifa</h2>
                <div class="form-group">
                    <label>Chagua Jina</label>
                    <select id="printPersonalMember" class="modern-select">
                        <option value="">Chagua Mwanachama</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="printPersonalReport()">Chapisha Taarifa Binafsi</button>
                <button class="btn btn-primary" onclick="printDebtors()">Chapisha Hali ya Malipo</button>
                <button class="btn btn-primary" onclick="printContributions()">Chapisha Michango</button>
                <button class="btn btn-primary" onclick="printFinance()">Chapisha Mapato/Matumizi</button>
            </div>
        </div>

        <div id="comments" class="tab-content">
            <div class="card">
                <h2>Maoni</h2>
                <form id="commentForm">
                    <div class="form-group">
                        <label>Jina Lako</label>
                        <input type="text" id="commentName" required>
                    </div>
                    <div class="form-group">
                        <label>Maoni Yako</label>
                        <input type="text" id="commentText" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Tuma Maoni</button>
                </form>
                <div id="commentsList"></div>
            </div>
        </div>

        <div id="admin" class="tab-content">
            <div class="card">
                <h2>Admin Panel</h2>
                <div id="adminLoginForm">
                    <div class="form-group">
                        <label>Neno la Siri</label>
                        <input type="password" id="adminPassword">
                    </div>
                    <button class="btn btn-primary" onclick="loginAdmin()">Ingia</button>
                </div>
                <div id="adminPanel" style="display: none;">
                    <button class="btn btn-danger" onclick="logoutAdmin()">Toka</button>
                    <div id="pendingPayments">
                        <h3>Uthibitisho wa Malipo</h3>
                        <div id="pendingPaymentsTable"></div>
                    </div>
                    <div class="form-group">
                        <label>Tangazo</label>
                        <input type="text" id="announcementTextInput">
                        <button class="btn btn-primary" onclick="postAnnouncement()">Chapisha Tangazo</button>
                    </div>
                    <div id="announcementsList"></div>
                    <div class="form-group">
                        <label>Badilisha Katiba</label>
                        <input type="text" id="constitutionText">
                        <button class="btn btn-primary" onclick="updateConstitution()">Hifadhi</button>
                    </div>
                    <div class="form-group">
                        <label>Badilisha Neno la Siri</label>
                        <input type="password" id="newAdminPassword">
                        <button class="btn btn-primary" onclick="changeAdminPassword()">Badilisha</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <span class="powered-by">POWERED BY MALOSHA</span>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">×</span>
            <div class="modal-icon" id="modalIcon"></div>
            <h2 id="modalTitle">Title</h2>
            <p id="modalMessage">Message</p>
            <button class="btn btn-primary" onclick="closeModal()">Sawa</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="text/javascript">
        const { jsPDF } = window.jspdf;
        const firebaseConfig = {
            apiKey: "AIzaSyAweqJDGhTOUSfYPm8zQ-o2vRM9k2_ooiQ",
            authDomain: "kamhanga-program.firebaseapp.com",
            databaseURL: "https://kamhanga-program-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "kamhanga-program",
            storageBucket: "kamhanga-program.firebasestorage.app",
            messagingSenderId: "52295319869",
            appId: "1:52295319869:web:9ccf9637ea0c3d6c4e0554",
            measurementId: "G-4772P894WS"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const CONSTANT_PASSWORD = '1360';
        let customAdminPassword = null;
        const MONTHLY_FEE = 2000;
        const ENTRY_FEE = 10000;
        const MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const CURRENT_MONTH_INDEX = 3; // April (0-based index)

        function showModal(title, message, type = 'info') {
            const modal = document.getElementById('modal');
            const modalContent = modal.querySelector('.modal-content');
            modal.querySelector('#modalTitle').textContent = title;
            modal.querySelector('#modalMessage').innerHTML = message;
            modalContent.className = `modal-content ${type}`;
            modal.querySelector('#modalIcon').textContent = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.nav-menu li').forEach(li => li.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            document.querySelector(`.nav-menu li[onclick="openTab('${tabName}')"]`).classList.add('active');
        }

        function saveRegistration(data) {
            console.log('Saving registration:', JSON.stringify(data));
            database.ref('members').once('value')
                .then(snap => {
                    const members = snap.val() || {};
                    const nameExists = Object.values(members).some(m => 
                        m.fullName && m.fullName.toLowerCase() === data.fullName.toLowerCase()
                    );
                    const phoneExists = Object.values(members).some(m => m.phone === data.phone);

                    if (nameExists) {
                        showModal('Hitilafu', 'Jina hili tayari limesajiliwa!', 'error');
                        return;
                    }
                    if (phoneExists) {
                        showModal('Hitilafu', 'Namba ya simu tayari imesajiliwa!', 'error');
                        return;
                    }

                    return database.ref('members').push(data)
                        .then(() => {
                            showModal('Usajili', 'Umesajiliwa kwa mafanikio kimamilifu asante!', 'success');
                            document.getElementById('registrationForm').reset();
                            loadMembers();
                            loadMembersAlphabetically();
                        });
                })
                .catch(err => {
                    console.error('Registration Error:', err);
                    showModal('Hitilafu', 'Tatizo la usajili: ' + err.message, 'error');
                });
        }

        function savePayment(data) {
            console.log('Saving payment:', JSON.stringify(data));
            database.ref('payments').push(data)
                .then(() => {
                    showModal('Malipo', 'Malipo yamepokelewa! Yanangoja uthibitisho wa faraja herman.', 'success');
                    document.getElementById('paymentForm').reset();
                    loadPendingPayments();
                })
                .catch(err => {
                    console.error('Payment Error:', err);
                    showModal('Hitilafu', 'Tatizo la malipo: ' + err.message, 'error');
                });
        }

        function togglePaymentFields() {
            const paymentType = document.getElementById('paymentType').value;
            document.getElementById('feeMonthField').style.display = paymentType === 'Ada' ? 'block' : 'none';
            document.getElementById('dateField').style.display = paymentType !== 'Ada' ? 'block' : 'none';
        }

        function loadMembers() {
            database.ref('members').once('value')
                .then(snap => {
                    const members = snap.val() || {};
                    const options = Object.values(members)
                        .filter(m => m.phone && m.fullName)
                        .map(m => `<option value="${m.phone}">${m.fullName}</option>`)
                        .join('');
                    const defaultOption = '<option value="">Chagua Mwanachama</option>';
                    document.getElementById('paymentMember').innerHTML = defaultOption + options;
                    document.getElementById('personalMember').innerHTML = defaultOption + options;
                    document.getElementById('printPersonalMember').innerHTML = defaultOption + options;
                })
                .catch(err => console.error('Load Members Error:', err));
        }

        function loadMembersAlphabetically() {
            database.ref('members').once('value')
                .then(snap => {
                    const members = snap.val() || {};
                    const validMembers = Object.values(members).filter(m => m.fullName && typeof m.fullName === 'string');
                    const sortedMembers = validMembers.sort((a, b) => 
                        (a.fullName || '').localeCompare(b.fullName || '')
                    );
                    const list = sortedMembers.map(m => `<li>${m.fullName} - ${m.phone}</li>`).join('');
                    document.getElementById('membersListAlphabet').innerHTML = `<ul>${list || '<li>Hakuna wanachama</li>'}</ul>`;
                })
                .catch(err => {
                    console.error('Load Members Alphabetically Error:', err);
                    document.getElementById('membersListAlphabet').innerHTML = '<p>Hakuna data au hitilafu imetokea.</p>';
                });
        }

        function loadDebtors() {
            const month = document.getElementById('debtMonth').value;
            if (!month) return;
            Promise.all([
                database.ref('members').once('value'),
                database.ref('payments').orderByChild('paymentMonth').equalTo(month).once('value')
            ])
                .then(([membersSnap, paymentsSnap]) => {
                    const members = membersSnap.val() || {};
                    const payments = paymentsSnap.val() || {};
                    const paidPhones = new Set(Object.values(payments).filter(p => p.status === 'confirmed').map(p => p.paymentPhone));
                    let paid = '', unpaid = '';
                    Object.values(members).forEach(m => {
                        if (paidPhones.has(m.phone)) paid += `<li>${m.fullName} - Amelipa</li>`;
                        else unpaid += `<li>${m.fullName} - Hajalipa</li>`;
                    });
                    document.getElementById('debtorsList').innerHTML = `<h3>Waliolipa</h3><ul>${paid || 'Hakuna'}</ul><h3>Waliobaki</h3><ul>${unpaid || 'Hakuna'}</ul>`;
                })
                .catch(err => console.error('Load Debtors Error:', err));
        }

        function loadContributions() {
            const type = document.getElementById('contributionType').value;
            if (!type) return;
            Promise.all([
                database.ref('members').once('value'),
                database.ref('payments').orderByChild('paymentType').equalTo(type).once('value')
            ])
                .then(([membersSnap, paymentsSnap]) => {
                    const members = membersSnap.val() || {};
                    const payments = paymentsSnap.val() || {};
                    const paidPhones = new Set(Object.values(payments).filter(p => p.status === 'confirmed').map(p => p.paymentPhone));
                    let paid = '', unpaid = '';
                    Object.values(members).forEach(m => {
                        if (paidPhones.has(m.phone)) {
                            const payment = Object.values(payments).find(p => p.paymentPhone === m.phone);
                            paid += `<li>${m.fullName} - TSh ${payment.paymentAmount} (${payment.paymentMonth || payment.paymentDate})</li>`;
                        } else {
                            unpaid += `<li>${m.fullName} - Hajatoa</li>`;
                        }
                    });
                    document.getElementById('contributionsList').innerHTML = `<h3>Waliotoa</h3><ul>${paid || 'Hakuna'}</ul><h3>Waliobaki</h3><ul>${unpaid || 'Hakuna'}</ul>`;
                })
                .catch(err => console.error('Load Contributions Error:', err));
        }

        function loadPersonalReport() {
            const phone = document.getElementById('personalMember').value;
            if (!phone) return showModal('Hitilafu', 'Chagua mwanachama kwanza!', 'error');
            Promise.all([
                database.ref('members').orderByChild('phone').equalTo(phone).once('value'),
                database.ref('payments').orderByChild('paymentPhone').equalTo(phone).once('value')
            ])
                .then(([memberSnap, paymentsSnap]) => {
                    const member = Object.values(memberSnap.val() || {})[0];
                    const payments = paymentsSnap.val() || {};
                    const confirmedPayments = Object.values(payments).filter(p => p.status === 'confirmed');
                    let report = `<h3>${member.fullName}</h3><h4>Michango Iliyolipwa</h4><ul>`;
                    confirmedPayments.forEach(p => {
                        report += `<li>${p.paymentType} - TSh ${p.paymentAmount} (${p.paymentMonth || p.paymentDate})</li>`;
                    });
                    report += '</ul>';

                    const paidMonths = new Set(confirmedPayments.filter(p => p.paymentType === 'Ada').map(p => p.paymentMonth));
                    const paidEntryFee = confirmedPayments.some(p => p.paymentType === 'Hela ya Kiingilio');
                    let debt = 0;
                    let pending = '<h4>Michango Inayodaiwa</h4><ul>';
                    for (let i = 0; i <= CURRENT_MONTH_INDEX; i++) {
                        if (!paidMonths.has(MONTHS[i])) {
                            pending += `<li>Ada ya ${MONTHS[i]} - TSh ${MONTHLY_FEE}</li>`;
                            debt += MONTHLY_FEE;
                        }
                    }
                    if (!paidEntryFee) {
                        pending += `<li>Hela ya Kiingilio - TSh ${ENTRY_FEE}</li>`;
                        debt += ENTRY_FEE;
                    }
                    pending += '</ul>';
                    report += pending + `<p><strong>Jumla ya Madeni: TSh ${debt}</strong></p>`;
                    document.getElementById('personalReport').innerHTML = report;
                })
                .catch(err => console.error('Load Personal Report Error:', err));
        }

        function addIncome() {
            const amount = document.getElementById('incomeAmount').value;
            if (!amount) return showModal('Hitilafu', 'Ingiza kiasi cha mapato!', 'error');
            database.ref('income').push({ amount: Number(amount), timestamp: Date.now(), source: 'Manual Entry' })
                .then(() => {
                    document.getElementById('incomeAmount').value = '';
                    loadFinance();
                });
        }

        function addExpense() {
            const amount = document.getElementById('expenseAmount').value;
            const desc = document.getElementById('expenseDesc').value;
            if (!amount || !desc) return showModal('Hitilafu', 'Ingiza kiasi na maelezo ya matumizi!', 'error');
            database.ref('expenses').push({ amount: Number(amount), description: desc, timestamp: Date.now() })
                .then(() => {
                    document.getElementById('expenseAmount').value = '';
                    document.getElementById('expenseDesc').value = '';
                    loadFinance();
                });
        }

        function loadFinance() {
            Promise.all([
                database.ref('payments').once('value'),
                database.ref('income').once('value'),
                database.ref('expenses').once('value')
            ])
                .then(([paymentsSnap, incomeSnap, expensesSnap]) => {
                    const payments = paymentsSnap.val() || {};
                    const income = incomeSnap.val() || {};
                    const expenses = expensesSnap.val() || {};
                    const totalIncome = Object.values(payments).filter(p => p.status === 'confirmed').reduce((sum, p) => sum + Number(p.paymentAmount), 0) +
                        Object.values(income).reduce((sum, i) => sum + Number(i.amount), 0);
                    const totalExpenses = Object.values(expenses).reduce((sum, e) => sum + Number(e.amount), 0);
                    document.getElementById('financeSummary').innerHTML = `
                        <p>Mapato: TSh ${totalIncome}</p>
                        <p>Matumizi: TSh ${totalExpenses}</p>
                        <p>Salio: TSh ${totalIncome - totalExpenses}</p>
                    `;
                })
                .catch(err => console.error('Load Finance Error:', err));
        }

        function generateFinanceReport(period) {
            Promise.all([
                database.ref('payments').once('value'),
                database.ref('income').once('value'),
                database.ref('expenses').once('value')
            ])
                .then(([paymentsSnap, incomeSnap, expensesSnap]) => {
                    const payments = paymentsSnap.val() || {};
                    const income = incomeSnap.val() || {};
                    const expenses = expensesSnap.val() || {};
                    const now = new Date();
                    let startTime;

                    if (period === 'week') startTime = now.getTime() - 7 * 24 * 60 * 60 * 1000;
                    else if (period === 'month') startTime = now.getTime() - 30 * 24 * 60 * 60 * 1000;
                    else startTime = now.getTime() - 365 * 24 * 60 * 60 * 1000;

                    const filteredPayments = Object.values(payments).filter(p => p.status === 'confirmed' && p.timestamp >= startTime);
                    const filteredIncome = Object.values(income).filter(i => i.timestamp >= startTime);
                    const filteredExpenses = Object.values(expenses).filter(e => e.timestamp >= startTime);

                    const doc = new jsPDF();
                    doc.text(`Ripoti ya Mapato/Matumizi - ${period === 'week' ? 'Wiki' : period === 'month' ? 'Mwezi' : 'Mwaka'}`, 10, 10);
                    doc.text('Mapato', 10, 20);
                    let y = 30;
                    filteredPayments.forEach(p => {
                        doc.text(`${p.paymentType} - TSh ${p.paymentAmount} (${new Date(p.timestamp).toLocaleString()})`, 10, y);
                        y += 10;
                    });
                    filteredIncome.forEach(i => {
                        doc.text(`${i.source} - TSh ${i.amount} (${new Date(i.timestamp).toLocaleString()})`, 10, y);
                        y += 10;
                    });
                    doc.text('Matumizi', 10, y + 10);
                    y += 20;
                    filteredExpenses.forEach(e => {
                        doc.text(`${e.description} - TSh ${e.amount} (${new Date(e.timestamp).toLocaleString()})`, 10, y);
                        y += 10;
                    });
                    const totalIncome = filteredPayments.reduce((sum, p) => sum + Number(p.paymentAmount), 0) + filteredIncome.reduce((sum, i) => sum + Number(i.amount), 0);
                    const totalExpenses = filteredExpenses.reduce((sum, e) => sum + Number(e.amount), 0);
                    doc.text(`Jumla ya Mapato: TSh ${totalIncome}`, 10, y + 10);
                    doc.text(`Jumla ya Matumizi: TSh ${totalExpenses}`, 10, y + 20);
                    doc.text(`Salio: TSh ${totalIncome - totalExpenses}`, 10, y + 30);
                    doc.save(`Ripoti_${period}_${new Date().toISOString().split('T')[0]}.pdf`);
                });
        }

        function loadConstitution() {
            database.ref('constitution').once('value')
                .then(snap => {
                    document.getElementById('constitutionContent').innerHTML = snap.val() || '<p>Hakuna katiba bado.</p>';
                });
        }

        function saveComment(data) {
            database.ref('comments').push(data)
                .then(() => {
                    showModal('Maoni', 'Maoni yako yametumwa!', 'success');
                    document.getElementById('commentForm').reset();
                    loadComments();
                })
                .catch(err => showModal('Hitilafu', 'Tatizo la kutuma maoni: ' + err.message, 'error'));
        }

        function loadComments() {
            database.ref('comments').once('value')
                .then(snap => {
                    const comments = snap.val() || {};
                    const list = Object.values(comments).map(c => `<li><strong>${c.name}</strong>: ${c.text} (${new Date(c.timestamp).toLocaleString()})</li>`).join('');
                    document.getElementById('commentsList').innerHTML = `<ul>${list || '<li>Hakuna maoni bado</li>'}</ul>`;
                });
        }

        function loginAdmin() {
            const password = document.getElementById('adminPassword').value;
            if (password === CONSTANT_PASSWORD || password === customAdminPassword) {
                document.getElementById('adminLoginForm').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadPendingPayments();
                loadAnnouncements();
                loadConstitution();
            } else {
                showModal('Hitilafu', 'Neno la siri si sahihi!', 'error');
            }
        }

        function logoutAdmin() {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminLoginForm').style.display = 'block';
            document.getElementById('adminPassword').value = '';
        }

        function loadPendingPayments() {
            database.ref('payments').orderByChild('status').equalTo('pending').once('value')
                .then(snap => {
                    const payments = snap.val() || {};
                    let html = '<table class="table"><tr><th>Jina</th><th>Aina</th><th>Kiasi</th><th>Thibitisha</th></tr>';
                    Promise.all(
                        Object.entries(payments).map(([id, p]) => {
                            if (!p.paymentPhone) return Promise.resolve('');
                            return database.ref('members').orderByChild('phone').equalTo(p.paymentPhone).once('value')
                                .then(memberSnap => {
                                    const member = Object.values(memberSnap.val() || {})[0] || { fullName: 'Unknown' };
                                    return `<tr><td>${member.fullName}</td><td>${p.paymentType}</td><td>TSh ${p.paymentAmount}</td><td><button class="btn btn-success" onclick="confirmPayment('${id}')">Thibitisha</button></td></tr>`;
                                });
                        })
                    ).then(rows => {
                        html += rows.join('') + '</table>';
                        document.getElementById('pendingPaymentsTable').innerHTML = html;
                    });
                })
                .catch(err => console.error('Load Pending Payments Error:', err));
        }

        function confirmPayment(paymentId) {
            database.ref('payments/' + paymentId).update({ status: 'confirmed', confirmedTimestamp: Date.now() })
                .then(() => loadPendingPayments());
        }

        function postAnnouncement() {
            const text = document.getElementById('announcementTextInput').value;
            if (!text) return showModal('Hitilafu', 'Ingiza tangazo!', 'error');
            database.ref('announcements').set({ text, timestamp: Date.now() })
                .then(() => {
                    document.getElementById('announcementTextInput').value = '';
                    loadAnnouncements();
                });
        }

        function loadAnnouncements() {
            database.ref('announcements').once('value')
                .then(snap => {
                    const announcements = snap.val() || {};
                    if (announcements.text) {
                        document.getElementById('announcementText').textContent = announcements.text;
                        document.getElementById('announcementsList').innerHTML = `<h3>Matangazo</h3><ul><li>${announcements.text} (${new Date(announcements.timestamp).toLocaleString()})</li></ul>`;
                    } else {
                        document.getElementById('announcementText').textContent = 'Hakuna tangazo bado.';
                        document.getElementById('announcementsList').innerHTML = '<h3>Matangazo</h3><ul><li>Hakuna matangazo bado</li></ul>';
                    }
                });
        }

        function updateConstitution() {
            const text = document.getElementById('constitutionText').value;
            if (!text) return showModal('Hitilafu', 'Ingiza katiba!', 'error');
            database.ref('constitution').set(text)
                .then(() => {
                    document.getElementById('constitutionText').value = '';
                    loadConstitution();
                });
        }

        function changeAdminPassword() {
            const newPassword = document.getElementById('newAdminPassword').value;
            if (!newPassword) return showModal('Hitilafu', 'Ingiza neno la siri jipya!', 'error');
            customAdminPassword = newPassword;
            document.getElementById('newAdminPassword').value = '';
            showModal('Mafanikio', 'Neno la siri limebadilishwa!', 'success');
        }

        function printPersonalReport() {
            const phone = document.getElementById('printPersonalMember').value;
            if (!phone) return showModal('Hitilafu', 'Chagua mwanachama kwanza!', 'error');
            Promise.all([
                database.ref('members').orderByChild('phone').equalTo(phone).once('value'),
                database.ref('payments').orderByChild('paymentPhone').equalTo(phone).once('value')
            ])
                .then(([memberSnap, paymentsSnap]) => {
                    const member = Object.values(memberSnap.val() || {})[0];
                    const payments = paymentsSnap.val() || {};
                    const confirmedPayments = Object.values(payments).filter(p => p.status === 'confirmed');
                    let report = `<h3>${member.fullName}</h3><h4>Michango Iliyolipwa</h4><ul>`;
                    confirmedPayments.forEach(p => {
                        report += `<li>${p.paymentType} - TSh ${p.paymentAmount} (${p.paymentMonth || p.paymentDate})</li>`;
                    });
                    report += '</ul>';

                    const paidMonths = new Set(confirmedPayments.filter(p => p.paymentType === 'Ada').map(p => p.paymentMonth));
                    const paidEntryFee = confirmedPayments.some(p => p.paymentType === 'Hela ya Kiingilio');
                    let debt = 0;
                    let pending = '<h4>Michango Inayodaiwa</h4><ul>';
                    for (let i = 0; i <= CURRENT_MONTH_INDEX; i++) {
                        if (!paidMonths.has(MONTHS[i])) {
                            pending += `<li>Ada ya ${MONTHS[i]} - TSh ${MONTHLY_FEE}</li>`;
                            debt += MONTHLY_FEE;
                        }
                    }
                    if (!paidEntryFee) {
                        pending += `<li>Hela ya Kiingilio - TSh ${ENTRY_FEE}</li>`;
                        debt += ENTRY_FEE;
                    }
                    pending += '</ul>';
                    report += pending + `<p><strong>Jumla ya Madeni: TSh ${debt}</strong></p>`;
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`<html><head><title>Taarifa Binafsi</title></head><body>${report}</body></html>`);
                    printWindow.document.close();
                    printWindow.print();
                });
        }

        function printDebtors() {
            const month = document.getElementById('debtMonth').value;
            if (!month) return showModal('Hitilafu', 'Chagua mwezi kwanza!', 'error');
            Promise.all([
                database.ref('members').once('value'),
                database.ref('payments').orderByChild('paymentMonth').equalTo(month).once('value')
            ])
                .then(([membersSnap, paymentsSnap]) => {
                    const members = membersSnap.val() || {};
                    const payments = paymentsSnap.val() || {};
                    const paidPhones = new Set(Object.values(payments).filter(p => p.status === 'confirmed').map(p => p.paymentPhone));
                    let report = `<h3>Hali ya Malipo - ${month}</h3><h4>Waliolipa</h4><ul>`;
                    Object.values(members).forEach(m => {
                        if (paidPhones.has(m.phone)) report += `<li>${m.fullName}</li>`;
                    });
                    report += '</ul><h4>Waliobaki</h4><ul>';
                    Object.values(members).forEach(m => {
                        if (!paidPhones.has(m.phone)) report += `<li>${m.fullName}</li>`;
                    });
                    report += '</ul>';
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`<html><head><title>Hali ya Malipo</title></head><body>${report}</body></html>`);
                    printWindow.document.close();
                    printWindow.print();
                });
        }

        function printContributions() {
            const type = document.getElementById('contributionType').value;
            if (!type) return showModal('Hitilafu', 'Chagua aina kwanza!', 'error');
            Promise.all([
                database.ref('members').once('value'),
                database.ref('payments').orderByChild('paymentType').equalTo(type).once('value')
            ])
                .then(([membersSnap, paymentsSnap]) => {
                    const members = membersSnap.val() || {};
                    const payments = paymentsSnap.val() || {};
                    let report = `<h3>Michango - ${type}</h3><h4>Waliotoa</h4><ul>`;
                    Object.values(payments).filter(p => p.status === 'confirmed').forEach(p => {
                        const member = Object.values(members).find(m => m.phone === p.paymentPhone);
                        report += `<li>${member.fullName} - TSh ${p.paymentAmount}</li>`;
                    });
                    report += '</ul><h4>Waliobaki</h4><ul>';
                    const paidPhones = new Set(Object.values(payments).map(p => p.paymentPhone));
                    Object.values(members).forEach(m => {
                        if (!paidPhones.has(m.phone)) report += `<li>${m.fullName}</li>`;
                    });
                    report += '</ul>';
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`<html><head><title>Michango</title></head><body>${report}</body></html>`);
                    printWindow.document.close();
                    printWindow.print();
                });
        }

        function printFinance() {
            Promise.all([
                database.ref('payments').once('value'),
                database.ref('income').once('value'),
                database.ref('expenses').once('value')
            ])
                .then(([paymentsSnap, incomeSnap, expensesSnap]) => {
                    const payments = paymentsSnap.val() || {};
                    const income = incomeSnap.val() || {};
                    const expenses = expensesSnap.val() || {};
                    const totalIncome = Object.values(payments).filter(p => p.status === 'confirmed').reduce((sum, p) => sum + Number(p.paymentAmount), 0) +
                        Object.values(income).reduce((sum, i) => sum + Number(i.amount), 0);
                    const totalExpenses = Object.values(expenses).reduce((sum, e) => sum + Number(e.amount), 0);
                    let report = `<h3>Mapato/Matumizi</h3><p>Mapato: TSh ${totalIncome}</p><p>Matumizi: TSh ${totalExpenses}</p><p>Salio: TSh ${totalIncome - totalExpenses}</p>`;
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`<html><head><title>Mapato/Matumizi</title></head><body>${report}</body></html>`);
                    printWindow.document.close();
                    printWindow.print();
                });
        }

        window.onload = function() {
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                document.querySelector('.container').style.display = 'block';
                openTab('home');
            }, 3000);

            document.getElementById('registrationForm').addEventListener('submit', e => {
                e.preventDefault();
                const data = {
                    fullName: document.getElementById('fullName').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    timestamp: Date.now(),
                    status: 'active'
                };
                saveRegistration(data);
            });

            document.getElementById('paymentForm').addEventListener('submit', e => {
                e.preventDefault();
                const paymentType = document.getElementById('paymentType').value;
                const data = {
                    paymentPhone: document.getElementById('paymentMember').value,
                    paymentType: paymentType,
                    paymentMonth: paymentType === 'Ada' ? document.getElementById('feeMonth').value : null,
                    paymentDate: paymentType !== 'Ada' ? document.getElementById('paymentDate').value : null,
                    paymentAmount: Number(document.getElementById('paymentAmount').value),
                    timestamp: Date.now(),
                    status: 'pending'
                };
                savePayment(data);
            });

            document.getElementById('commentForm').addEventListener('submit', e => {
                e.preventDefault();
                const name = document.getElementById('commentName')?.value;
                const text = document.getElementById('commentText')?.value;
                if (!name || !text) return showModal('Hitilafu', 'Jaza jina na maoni!', 'error');
                const data = { name, text, timestamp: Date.now() };
                saveComment(data);
            });

            loadMembers();
            loadMembersAlphabetically();
            loadFinance();
            loadConstitution();
            loadComments();
            loadAnnouncements();
        };
    </script>
</body>
</html>

